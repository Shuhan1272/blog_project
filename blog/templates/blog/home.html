{% extends "base.html" %}
{% block title %}All Blogs{% endblock %}
{% block content %}

<!-- Header with Create Blog -->
<div class="flex items-center justify-between mb-5">
  <h1 class="text-2xl sm:text-3xl font-semibold">All Blogs</h1>
  
  <a href="{% url 'create_blog' %}"
      class="inline-flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-xl hover:bg-indigo-700">
    <span class="text-lg leading-none">+</span> Create Blog
  </a>
  
</div>

<!-- Filters -->
<form method="get" class="bg-white border rounded-2xl p-4 sm:p-5 mb-6">
  <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Search</label>
      <input type="text" name="q" value="{{ request.GET.q }}"
             placeholder="Search blogs..."
             class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500" />
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Category</label>
      <select name="category" class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
        <option value="">All</option>
        {% for cat in categories %}
          <option value="{{ cat.slug }}" {% if request.GET.category == cat.slug %}selected{% endif %}>
            {{ cat.category_name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Author</label>
      <select name="author" class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
        <option value="">All</option>
        {% for a in authors %}
          <option value="{{ a.id }}" {% if request.GET.author == a.id|stringformat:"s" %}selected{% endif %}>
            {% if request.user == a %} 
              {{a.full_name}} (Me)
            {% else %}
              {{ a.full_name }}
            {% endif %}
          </option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Date</label>
      <input type="date" name="date" value="{{ request.GET.date }}"
             class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500" />
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Sort</label>
      <select name="sort" class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
        <option value="">—</option>
        <option value="latest" {% if request.GET.sort == "latest" %}selected{% endif %}>Latest</option>
        <option value="rating" {% if request.GET.sort == "rating" %}selected{% endif %}>Top Rated</option>
      </select>
    </div>
  </div>
  <div class="mt-4 flex items-center gap-2 justify-end">
    <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Apply</button>
    <a href="{% url 'home' %}" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Reset</a>
  </div>
</form>

<!-- Blog Cards Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  {% for blog in blogs %}
    <article class="bg-white border rounded-2xl shadow-sm hover:shadow-md transition-shadow">
      <div class="p-5">
        <!-- Categories -->
        <div class="mb-2 flex flex-wrap gap-2">
          {% for cat in blog.categories.all %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs bg-indigo-50 text-indigo-700 border border-indigo-100">
              {{ cat.category_name }}
            </span>
          {% empty %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs bg-gray-100 text-gray-600">Uncategorized</span>
          {% endfor %}
        </div>

        <!-- Title -->
        <h2 class="text-xl font-semibold leading-tight">
          <a href="{% url 'blog_detail' blog.slug %}" class="text-indigo-700 hover:text-indigo-800">
            {{ blog.title }}
          </a>
        </h2>

        <!-- Meta -->
        <div class="mt-1 text-sm text-gray-500">
          By
          <a href="{% url 'profile' blog.author.id %}" class="text-gray-700 hover:text-indigo-600 font-medium">
            {{ blog.author.full_name}}
          </a>
          • {{ blog.created_at|date:"M d, Y H:i" }}
        </div>

        <!-- Excerpt -->
        <p class="mt-3 text-gray-700">{{ blog.body|truncatewords:32 }}</p>

        <!-- Rating -->
        <div class="mt-3 text-sm">
          <span class="inline-flex items-center gap-1">
            <span>⭐</span>
            <span class="font-semibold">{{ blog.avg_rating|default:"0" }}/6</span>
            {% if blog.rating_count %}<span class="text-gray-500">({{ blog.rating_count }} reviews)</span>{% endif %}
          </span>
        </div>
      </div>

      <!-- Inline Actions -->
      <div class="px-5 pb-5">
        <div class="flex flex-wrap gap-2">
          <a href="{% url 'blog_detail' blog.slug %}" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50 text-sm">Details</a>
          
          <a href="javascript:void(0);" 
          onclick="openReviewModal('{{ blog.slug }}', '{{ blog.user_review.rating }}', '{{ blog.user_review.review|escapejs }}')" 
          class="px-3 py-1.5 rounded-lg border hover:bg-gray-50 text-sm">
          Leave Review
          </a>
          
          <a href="{% url 'blog_reviews' blog.slug %}" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50 text-sm">Show Reviews</a>

          {% if user.is_authenticated and user == blog.author %}
            <a href="{% url 'edit_blog' blog.slug %}" class="px-3 py-1.5 rounded-lg border text-green-700 hover:bg-green-50 text-sm">Edit</a>
            <a href="javascript:void(0);" onclick="openDeleteModal('{{ blog.slug }}')" class="px-3 py-1.5 rounded-lg border text-red-700 hover:bg-red-50 text-sm">Delete</a>
          {% endif %}

          {% if blog.is_favorited %}
            <!-- Already favorited -->
            <a href="{% url 'toggle_favorite' blog.slug %}"
              class="px-3 py-1.5 rounded-lg bg-emerald-400 hover:bg-emerald-600 text-sm text-white transition">
              ✅ Favorited
            </a>
          {% else %}
            <!-- Not yet favorited -->
            <a href="{% url 'toggle_favorite' blog.slug %}"
              class="px-3 py-1.5 rounded-lg border hover:bg-gray-50 text-sm">
              ⭐ Favorite
            </a>
          {% endif %}
        </div>
      </div>
    </article>
  {% empty %}
    <div class="col-span-2">
      <div class="bg-white border rounded-2xl p-10 text-center text-gray-500">No blogs found.</div>
    </div>
  {% endfor %}
</div>

<!-- Optional: Pagination -->
{% if is_paginated %}
  <div class="mt-8 flex items-center justify-center gap-2">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50 text-sm">Previous</a>
    {% endif %}
    <span class="px-3 py-1.5 rounded-lg bg-gray-100 text-sm">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50 text-sm">Next</a>
    {% endif %}
  </div>
{% endif %}


<!-- Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">

    <!-- Header -->
    <div class="flex items-center space-x-3 mb-4">
      <div class="bg-red-100 text-red-600 rounded-full p-2">⚠️</div>
      <h2 class="text-lg font-semibold text-gray-800">Confirm Delete</h2>
    </div>

    <!-- Body -->
    <p class="text-gray-600 mb-6">
      Are you sure you want to delete this blog post?  
      <span class="font-medium">This action cannot be undone.</span>
    </p>

    <!-- Footer -->
    <div class="flex justify-end space-x-3">
      <button onclick="closeDeleteModal()" 
              class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100">
        Cancel
      </button>
      <form id="deleteForm" method="post">
        {% csrf_token %}
        <button type="submit" 
                class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-lg shadow">
          Yes, Delete
        </button>
      </form>
    </div>

  </div>
</div>

<script>
  function openDeleteModal(slug) {
    // Update form action dynamically with blog slug
    const form = document.getElementById('deleteForm');
    form.action = `/${slug}/delete/`;  // adapt if your URL pattern differs
    document.getElementById('deleteModal').classList.remove('hidden');
  }
  function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
  }
</script>


<!-- Review Modal -->
<div id="reviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">

    <!-- Header -->
    <div class="flex items-center space-x-3 mb-4">
      <div class="bg-yellow-100 text-yellow-600 rounded-full p-2">⭐</div>
      <h2 class="text-lg font-semibold text-gray-800">Leave a Review</h2>
    </div>

    <!-- Body -->
    <form id="reviewForm" method="post">
      {% csrf_token %}
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Rating (0-6)</label>
        <input type="number" name="rating" min="0" max="6" step="0.5" 
               class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
               placeholder="Enter rating..." required>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Review (optional)</label>
        <textarea name="review" rows="4" 
                  class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
                  placeholder="Write your review (max 500 chars)"></textarea>
      </div>

      <!-- Footer Buttons -->
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeReviewModal()" 
                class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100">
          Cancel
        </button>
        <button type="submit" 
                class="bg-yellow-600 hover:bg-yellow-700 text-white px-5 py-2 rounded-lg shadow">
          Submit Review
        </button>
      </div>
    </form>

  </div>
</div>

<script>
  function openReviewModal(slug, rating='', reviewText='') {
    const form = document.getElementById('reviewForm');
    form.action = `/${slug}/review/`;  // adapt to your URL pattern
    form.rating.value = rating;
    form.review.value = reviewText;
    document.getElementById('reviewModal').classList.remove('hidden');
  }

  function closeReviewModal() {
    document.getElementById('reviewModal').classList.add('hidden');
  }
</script>

{% endblock %}
